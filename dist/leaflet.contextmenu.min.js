/*
	Leaflet.contextmenu, a context menu for Leaflet.
	(c) 2015, Adam Ratcliffe, GeoSmart Maps Limited

        @preserve
*/
(function(t){var e;if(typeof define==="function"&&define.amd){define(["leaflet"],t)}else if(typeof module==="object"&&typeof module.exports==="object"){e=require("leaflet");module.exports=t(e)}else{if(typeof window.L==="undefined"){throw new Error("Leaflet must be loaded first")}t(window.L)}})(function(t){t.Map.mergeOptions({contextmenuItems:[]});t.Map.ContextMenu=t.Handler.extend({_touchstart:t.Browser.msPointer?"MSPointerDown":t.Browser.pointer?"pointerdown":"touchstart",statics:{BASE_CLS:"leaflet-contextmenu"},initialize:function(e){t.Handler.prototype.initialize.call(this,e);this._items=[];this._visible=false;var i=t.DomUtil.create("div",t.Map.ContextMenu.BASE_CLS,e._container);var n=this._container=t.DomUtil.create("ul","dropdown-menu",i);n.style.zIndex=1e4;n.style.position="absolute";if(e.options.contextmenuWidth){n.style.width=e.options.contextmenuWidth+"px"}this._createItems();t.DomEvent.on(n,"click",t.DomEvent.stop).on(n,"mousedown",t.DomEvent.stop).on(n,"dblclick",t.DomEvent.stop).on(n,"contextmenu",t.DomEvent.stop)},addHooks:function(){var e=this._map.getContainer();t.DomEvent.on(e,"mouseleave",this._hide,this).on(document,"keydown",this._onKeyDown,this);if(t.Browser.touch){t.DomEvent.on(document,this._touchstart,this._hide,this)}this._map.on({contextmenu:this._show,mousedown:this._hide,movestart:this._hide,zoomstart:this._hide},this)},removeHooks:function(){var e=this._map.getContainer();t.DomEvent.off(e,"mouseleave",this._hide,this).off(document,"keydown",this._onKeyDown,this);if(t.Browser.touch){t.DomEvent.off(document,this._touchstart,this._hide,this)}this._map.off({contextmenu:this._show,mousedown:this._hide,movestart:this._hide,zoomstart:this._hide},this)},showAt:function(e,i){if(e instanceof t.LatLng){e=this._map.latLngToContainerPoint(e)}this._showAtPoint(e,i)},hide:function(){this._hide()},addItem:function(t){return this.insertItem(t)},insertItem:function(t,e){e=e!==undefined?e:this._items.length;var i=this._createItem(this._container,t,e);this._items.push(i);this._sizeChanged=true;this._map.fire("contextmenu.additem",{contextmenu:this,el:i.el,index:e});return i.el},removeItem:function(e){var i=this._container;if(!isNaN(e)){e=i.children[e]}if(e){this._removeItem(t.Util.stamp(e));this._sizeChanged=true;this._map.fire("contextmenu.removeitem",{contextmenu:this,el:e})}},removeAllItems:function(){var e;while(this._container.children.length){e=this._container.children[0];this._removeItem(t.Util.stamp(e))}},hideAllItems:function(){var t,e,i;for(e=0,i=this._items.length;e<i;e++){t=this._items[e];t.el.style.display="none"}},showAllItems:function(){var t,e,i;for(e=0,i=this._items.length;e<i;e++){t=this._items[e];t.el.style.display=""}},setDisabled:function(e,i){var n=this._container,o=t.Map.ContextMenu.BASE_CLS+"-item";if(!isNaN(e)){e=n.children[e]}if(e&&t.DomUtil.hasClass(e,o)){if(i){t.DomUtil.addClass(e,"disabled");this._map.fire("contextmenu.disableitem",{contextmenu:this,el:e})}else{t.DomUtil.removeClass(e,"disabled");this._map.fire("contextmenu.enableitem",{contextmenu:this,el:e})}}},isVisible:function(){return this._visible},_createItems:function(){var t=this._map.options.contextmenuItems,e,i,n;for(i=0,n=t.length;i<n;i++){this._items.push(this._createItem(this._container,t[i]))}},_createItem:function(e,i,n){if(i.separator||i==="-"){return this._createSeparator(e,n)}var o=t.Map.ContextMenu.BASE_CLS+"-item",s=i.disabled?o+" disabled":o,h=this._insertElementAt("li",s,e,n);el=t.DomUtil.create("a","",h),callback=this._createEventHandler(el,i.callback,i.context,i.hideOnSelect),html="";if(i.icon){html='<img class="'+t.Map.ContextMenu.BASE_CLS+'-icon" src="'+i.icon+'"/>'}else if(i.iconCls){html='<span class="'+t.Map.ContextMenu.BASE_CLS+"-icon "+i.iconCls+'"></span>'}el.innerHTML=html+i.text;el.href="#";t.DomEvent.on(el,"mouseover",this._onItemMouseOver,this).on(el,"mouseout",this._onItemMouseOut,this).on(el,"mousedown",t.DomEvent.stopPropagation).on(el,"click",callback);return{id:t.Util.stamp(el),el:el,callback:callback}},_removeItem:function(e){var i,n,o,s,h;for(o=0,s=this._items.length;o<s;o++){i=this._items[o];if(i.id===e){n=i.el;h=i.callback;if(h){t.DomEvent.off(n,"mouseover",this._onItemMouseOver,this).off(n,"mouseover",this._onItemMouseOut,this).off(n,"mousedown",t.DomEvent.stopPropagation).off(n,"click",h)}this._container.removeChild(n);this._items.splice(o,1);return i}}return null},_createSeparator:function(e,i){var n=this._insertElementAt("li","divider",e,i);return{id:t.Util.stamp(n),el:n}},_createEventHandler:function(e,i,n,o){var s=this,h=this._map,a="disabled",o=o!==undefined?o:true;return function(m){if(t.DomUtil.hasClass(e,a)){return}if(o){s._hide()}if(i){i.call(n||h,s._showLocation)}s._map.fire("contextmenu:select",{contextmenu:s,el:e})}},_insertElementAt:function(t,e,i,n){var o,s=document.createElement(t);s.className=e;if(n!==undefined){o=i.children[n]}if(o){i.insertBefore(s,o)}else{i.appendChild(s)}return s},_show:function(t){this._showAtPoint(t.containerPoint,t)},_showAtPoint:function(e,i){if(this._items.length){var n=this._map,o=n.containerPointToLayerPoint(e),s=n.layerPointToLatLng(o),h=t.extend(i||{},{contextmenu:this});this._showLocation={latlng:s,layerPoint:o,containerPoint:e};if(i&&i.relatedTarget){this._showLocation.relatedTarget=i.relatedTarget}this._setPosition(e);if(!this._visible){this._container.style.display="block";this._visible=true}else{this._setPosition(e)}this._map.fire("contextmenu.show",h)}},_hide:function(){if(this._visible){this._visible=false;this._container.style.display="none";this._map.fire("contextmenu.hide",{contextmenu:this})}},_setPosition:function(e){var i=this._map.getSize(),n=this._container,o=this._getElementSize(n),s;if(this._map.options.contextmenuAnchor){s=t.point(this._map.options.contextmenuAnchor);e=e.add(s)}n._leaflet_pos=e;if(e.x+o.x>i.x){n.style.left="auto";n.style.right=Math.max(i.x-e.x,0)+"px"}else{n.style.left=Math.max(e.x,0)+"px";n.style.right="auto"}if(e.y+o.y>i.y){n.style.top="auto";n.style.bottom=Math.max(i.y-e.y,0)+"px"}else{n.style.top=Math.max(e.y,0)+"px";n.style.bottom="auto"}},_getElementSize:function(t){var e=this._size,i=t.style.display;if(!e||this._sizeChanged){e={};t.style.left="-999999px";t.style.right="auto";t.style.display="block";e.x=t.offsetWidth;e.y=t.offsetHeight;t.style.left="auto";t.style.display=i;this._sizeChanged=false}return e},_onKeyDown:function(t){var e=t.keyCode;if(e===27){this._hide()}},_onItemMouseOver:function(e){t.DomUtil.addClass(e.target||e.srcElement,"over")},_onItemMouseOut:function(e){t.DomUtil.removeClass(e.target||e.srcElement,"over")}});t.Map.addInitHook("addHandler","contextmenu",t.Map.ContextMenu);t.Mixin.ContextMenu={bindContextMenu:function(e){t.setOptions(this,e);this._initContextMenu();return this},unbindContextMenu:function(){this.off("contextmenu",this._showContextMenu,this);return this},addContextMenuItem:function(t){this.options.contextmenuItems.push(t)},removeContextMenuItemWithIndex:function(t){var e=[];for(var i=0;i<this.options.contextmenuItems.length;i++){if(this.options.contextmenuItems[i].index==t){e.push(i)}}var n=e.pop();while(n!==undefined){this.options.contextmenuItems.splice(n,1);n=e.pop()}},replaceConextMenuItem:function(t){this.removeContextMenuItemWithIndex(t.index);this.addContextMenuItem(t)},_initContextMenu:function(){this._items=[];this.on("contextmenu",this._showContextMenu,this)},_showContextMenu:function(e){var i,n,o,s,h;if(this._map.contextmenu){n=t.extend({relatedTarget:this},e);o=this._map.mouseEventToContainerPoint(e.originalEvent);if(!this.options.contextmenuInheritItems){this._map.contextmenu.hideAllItems()}for(s=0,h=this.options.contextmenuItems.length;s<h;s++){i=this.options.contextmenuItems[s];this._items.push(this._map.contextmenu.insertItem(i,i.index))}this._map.once("contextmenu.hide",this._hideContextMenu,this);this._map.contextmenu.showAt(o,n)}},_hideContextMenu:function(){var t,e;for(t=0,e=this._items.length;t<e;t++){this._map.contextmenu.removeItem(this._items[t])}this._items.length=0;if(!this.options.contextmenuInheritItems){this._map.contextmenu.showAllItems()}}};var e=[t.Marker,t.Path],i={contextmenu:false,contextmenuItems:[],contextmenuInheritItems:true},n,o,s;for(o=0,s=e.length;o<s;o++){n=e[o];if(!n.prototype.options){n.prototype.options=i}else{n.mergeOptions(i)}n.addInitHook(function(){if(this.options.contextmenu){this._initContextMenu()}});n.include(t.Mixin.ContextMenu)}return t.Map.ContextMenu});